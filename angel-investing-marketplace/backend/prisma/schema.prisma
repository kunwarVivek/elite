// Prisma schema for Angel Investing Marketplace
// Complete database schema based on database-schema.md specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  emailVerified Boolean   @default(false)
  image         String?
  role          UserRole  @default(INVESTOR)
  avatarUrl     String?
  profileData   Json?
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  foundedStartups           Startup[]             @relation("StartupFounder")
  investments               Investment[]
  portfolios                Portfolio[]
  sentMessages              Message[]             @relation("MessageSender")
  receivedMessages          Message[]             @relation("MessageReceiver")
  notifications             Notification[]
  comments                  Comment[]
  uploadedDocuments         Document[]            @relation("DocumentUploader")
  transactions              Transaction[]
  auditLogs                 AuditLog[]
  userProfile               UserProfile?
  syndicateLedInvestments   Investment[]          @relation("SyndicateLead")
  sessions                  Session[]
  // Syndicate relations
  ledSyndicates             Syndicate[]           @relation("SyndicateLead")
  syndicateInvestments      SyndicateInvestment[]
  syndicateMessages         SyndicateMessage[]    @relation("SyndicateMessageSender")
  syndicateDocuments        SyndicateDocument[]   @relation("SyndicateDocumentUploader")
  // Secondary marketplace relations
  originalShareCertificates ShareCertificate[]    @relation("OriginalShareholder")
  currentShareCertificates  ShareCertificate[]    @relation("CurrentShareholder")
  orders                    Order[]
  trades                    Trade[]
  // Compliance relations
  complianceProfile         ComplianceProfile?
  // Auth relations
  accounts                  Account[]
  // Admin approval relations
  requestedApprovals        AdminApproval[]       @relation("ApprovalRequester")
  assignedApprovals         AdminApproval[]       @relation("ApprovalAssignee")
  reviewedApprovals         AdminApproval[]       @relation("ApprovalReviewer")
  // Company update relations
  authoredUpdates           CompanyUpdate[]       @relation("UpdateAuthor")
  updateEngagements         UpdateEngagement[]    @relation("UpdateEngagements")
  updateReactions           UpdateReaction[]      @relation("UpdateReactions")
  updateComments            UpdateComment[]       @relation("UpdateComments")
  // Equity round relations
  ledEquityRounds           EquityRound[]
  capTableStakeholders      CapTableStakeholder[]
  // Subscription relations
  subscriptions             Subscription[]
  paymentMethods            PaymentMethod[]

  // Indexes
  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([isVerified])
  @@index([emailVerified])
  @@map("users")
}

model UserProfile {
  id                  String              @id @default(cuid())
  userId              String              @unique
  bio                 String?
  location            String?
  linkedinUrl         String?
  twitterUrl          String?
  websiteUrl          String?
  investmentRangeMin  Decimal?            @db.Decimal(15, 2)
  investmentRangeMax  Decimal?            @db.Decimal(15, 2)
  preferredIndustries Json?
  previousExits       Json?
  accreditationStatus AccreditationStatus @default(PENDING)
  kycStatus           KycStatus           @default(PENDING)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([accreditationStatus])
  @@index([kycStatus])
  @@map("user_profiles")
}

// ============================================================================
// STARTUP MANAGEMENT
// ============================================================================

model Startup {
  id                   String       @id @default(cuid())
  name                 String
  slug                 String       @unique
  description          String?
  industry             String?
  stage                StartupStage
  fundingGoal          Decimal      @db.Decimal(15, 2)
  currentFunding       Decimal      @default(0) @db.Decimal(15, 2)
  founderId            String
  websiteUrl           String?
  logoUrl              String?
  teamSize             Int?
  foundedDate          DateTime?
  businessModel        String?
  targetMarket         String?
  competitiveAdvantage String?
  financialData        Json?
  isVerified           Boolean      @default(false)
  isActive             Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  founder        User            @relation("StartupFounder", fields: [founderId], references: [id])
  pitches        Pitch[]
  documents      Document[]
  companyUpdates CompanyUpdate[]
  equityRounds   EquityRound[]
  capTables      CapTable[]
  boardMeetings  BoardMeeting[]
  exitEvents     ExitEvent[]

  // Indexes
  @@index([founderId])
  @@index([industry])
  @@index([stage])
  @@index([slug])
  @@index([isVerified])
  @@index([isActive])
  @@index([createdAt])
  @@map("startups")
}

// ============================================================================
// PITCH MANAGEMENT
// ============================================================================

model Pitch {
  id                   String      @id @default(cuid())
  startupId            String
  title                String
  companyName          String?
  slug                 String      @unique
  summary              String?
  problemStatement     String?
  solution             String?
  marketOpportunity    String?
  competitiveAnalysis  String?
  financialProjections Json?
  fundingAmount        Decimal     @db.Decimal(15, 2)
  equityOffered        Decimal?    @db.Decimal(5, 2)
  minimumInvestment    Decimal     @db.Decimal(15, 2)
  status               PitchStatus @default(DRAFT)
  pitchDeckUrl         String?
  videoUrl             String?
  tags                 Json?
  viewCount            Int         @default(0)
  isFeatured           Boolean     @default(false)
  expiresAt            DateTime?
  approvedAt           DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  startup     Startup      @relation(fields: [startupId], references: [id], onDelete: Cascade)
  investments Investment[]
  messages    Message[]
  comments    Comment[]
  documents   Document[]

  // Indexes
  @@index([startupId])
  @@index([status])
  @@index([isFeatured])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([viewCount])
  @@index([status, isFeatured])
  @@index([status, createdAt])
  @@map("pitches")
}

// ============================================================================
// INVESTMENT MANAGEMENT
// ============================================================================

model Investment {
  id               String           @id @default(cuid())
  investorId       String
  pitchId          String
  amount           Decimal          @db.Decimal(15, 2)
  currency         String           @default("USD")
  equityPercentage Decimal?         @db.Decimal(5, 2)
  sharePrice       Decimal?         @db.Decimal(15, 2)
  status           InvestmentStatus @default(PENDING)
  investmentType   InvestmentType   @default(DIRECT)
  syndicateLeadId  String?
  terms            Json?
  legalDocuments   Json?
  escrowReference  String?
  escrowInfo       Json?
  paymentMethod    String?
  paymentReference String?
  investmentDate   DateTime?
  approvedAt       DateTime?
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  investor          User               @relation(fields: [investorId], references: [id])
  pitch             Pitch              @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  syndicateLead     User?              @relation("SyndicateLead", fields: [syndicateLeadId], references: [id])
  transactions      Transaction[]
  messages          Message[]
  // New relations for SPV and Share Certificates
  spvInvestments    SpvInvestment[]
  shareCertificates ShareCertificate[]
  // Compliance relations
  secRegulationD    SECRegulationD?
  // Investment instrument relations
  safeAgreement     SafeAgreement?
  convertibleNote   ConvertibleNote?
  investorRights    InvestorRights?

  // Indexes
  @@index([investorId])
  @@index([pitchId])
  @@index([status])
  @@index([investmentType])
  @@index([investmentDate])
  @@index([completedAt])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([investorId, status])
  @@map("investments")
}

// ============================================================================
// PORTFOLIO MANAGEMENT
// ============================================================================

model Portfolio {
  id              String   @id @default(cuid())
  investorId      String
  name            String
  description     String?
  isPublic        Boolean  @default(false)
  totalInvested   Decimal  @default(0) @db.Decimal(15, 2)
  totalValue      Decimal  @default(0) @db.Decimal(15, 2)
  totalExits      Decimal  @default(0) @db.Decimal(15, 2)
  investmentCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  investor User @relation(fields: [investorId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([investorId])
  @@index([isPublic])
  @@index([createdAt])
  @@map("portfolios")
}

// ============================================================================
// FINANCIAL MANAGEMENT
// ============================================================================

model Transaction {
  id                    String            @id @default(cuid())
  investmentId          String?
  userId                String
  type                  TransactionType
  amount                Decimal           @db.Decimal(15, 2)
  currency              String            @default("USD")
  status                TransactionStatus @default(PENDING)
  paymentMethod         String?
  paymentProvider       String?
  paymentReference      String?
  externalTransactionId String?
  feeAmount             Decimal           @default(0) @db.Decimal(15, 2)
  netAmount             Decimal           @db.Decimal(15, 2)
  description           String?
  metadata              Json?
  processedAt           DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  investment Investment? @relation(fields: [investmentId], references: [id])
  user       User        @relation(fields: [userId], references: [id])
  trades     Trade[]

  // Indexes
  @@index([userId])
  @@index([investmentId])
  @@index([type])
  @@index([status])
  @@index([externalTransactionId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([type, status])
  @@map("transactions")
}

// ============================================================================
// COMMUNICATION SYSTEM
// ============================================================================

model Message {
  id           String      @id @default(cuid())
  senderId     String
  receiverId   String
  pitchId      String?
  investmentId String?
  subject      String?
  content      String
  messageType  MessageType @default(GENERAL)
  isRead       Boolean     @default(false)
  readAt       DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  sender     User        @relation("MessageSender", fields: [senderId], references: [id])
  receiver   User        @relation("MessageReceiver", fields: [receiverId], references: [id])
  pitch      Pitch?      @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  investment Investment? @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([senderId])
  @@index([receiverId])
  @@index([pitchId])
  @@index([investmentId])
  @@index([isRead])
  @@index([createdAt])
  @@index([senderId, receiverId])
  @@index([isRead, createdAt])
  @@map("messages")
}

model Comment {
  id              String   @id @default(cuid())
  pitchId         String
  userId          String
  parentCommentId String?
  content         String
  isApproved      Boolean  @default(true)
  likesCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pitch         Pitch     @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id])
  parentComment Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies       Comment[] @relation("CommentReplies")

  // Indexes
  @@index([pitchId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([isApproved])
  @@index([createdAt])
  @@index([pitchId, createdAt])
  @@map("comments")
}

// ============================================================================
// COMPANY UPDATES & COMMUNICATIONS
// ============================================================================

model CompanyUpdate {
  id              String          @id @default(cuid())
  startupId       String
  authorId        String
  title           String
  slug            String          @unique
  content         String          @db.Text
  excerpt         String?
  updateType      UpdateType
  category        UpdateCategory?
  tags            String[]        @default([])
  coverImageUrl   String?
  attachments     Json?           @default("[]")
  metadata        Json?           @default("{}")
  status          UpdateStatus    @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?
  viewCount       Int             @default(0)
  reactionCount   Int             @default(0)
  commentCount    Int             @default(0)
  isHighlighted   Boolean         @default(false)
  isPinned        Boolean         @default(false)
  notifyInvestors Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  startup     Startup            @relation(fields: [startupId], references: [id], onDelete: Cascade)
  author      User               @relation("UpdateAuthor", fields: [authorId], references: [id])
  engagements UpdateEngagement[]
  comments    UpdateComment[]
  reactions   UpdateReaction[]

  // Indexes
  @@index([startupId])
  @@index([authorId])
  @@index([status])
  @@index([updateType])
  @@index([category])
  @@index([publishedAt])
  @@index([createdAt])
  @@index([startupId, status])
  @@index([startupId, publishedAt])
  @@index([isPinned, publishedAt])
  @@map("company_updates")
}

model UpdateEngagement {
  id          String   @id @default(cuid())
  updateId    String
  userId      String
  viewedAt    DateTime @default(now())
  timeSpent   Int? // seconds
  scrollDepth Float? // percentage
  createdAt   DateTime @default(now())

  update CompanyUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)
  user   User          @relation("UpdateEngagements", fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraint - one engagement record per user per update
  @@unique([updateId, userId])
  @@index([updateId])
  @@index([userId])
  @@index([viewedAt])
  @@map("update_engagements")
}

model UpdateReaction {
  id        String       @id @default(cuid())
  updateId  String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())

  update CompanyUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)
  user   User          @relation("UpdateReactions", fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraint - one reaction per user per update
  @@unique([updateId, userId])
  @@index([updateId])
  @@index([userId])
  @@index([type])
  @@map("update_reactions")
}

model UpdateComment {
  id              String   @id @default(cuid())
  updateId        String
  userId          String
  parentCommentId String?
  content         String   @db.Text
  isEdited        Boolean  @default(false)
  likesCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  update        CompanyUpdate   @relation(fields: [updateId], references: [id], onDelete: Cascade)
  user          User            @relation("UpdateComments", fields: [userId], references: [id])
  parentComment UpdateComment?  @relation("UpdateCommentReplies", fields: [parentCommentId], references: [id])
  replies       UpdateComment[] @relation("UpdateCommentReplies")

  // Indexes
  @@index([updateId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([createdAt])
  @@index([updateId, createdAt])
  @@map("update_comments")
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model Document {
  id                String       @id @default(cuid())
  startupId         String
  pitchId           String?
  name              String
  fileName          String
  filePath          String
  fileUrl           String
  fileType          DocumentType
  documentType      String
  fileSize          Int
  mimeType          String?
  isPublic          Boolean      @default(false)
  visibility        String       @default("PRIVATE")
  description       String?
  tags              Json?
  requiresSignature Boolean      @default(false)
  expiryDate        DateTime?
  downloadCount     Int          @default(0)
  version           Int          @default(1)
  relatedEntity     Json?
  uploadedBy        String
  uploadedAt        DateTime     @default(now())
  signatures        Json?
  createdBy         String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  startup  Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  pitch    Pitch?  @relation(fields: [pitchId], references: [id], onDelete: Cascade)
  uploader User    @relation("DocumentUploader", fields: [uploadedBy], references: [id])

  // Indexes
  @@index([startupId])
  @@index([pitchId])
  @@index([fileType])
  @@index([documentType])
  @@index([isPublic])
  @@index([visibility])
  @@index([uploadedBy])
  @@index([expiryDate])
  @@index([createdAt])
  @@map("documents")
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model Notification {
  id        String               @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  content   String
  data      Json?
  metadata  Json?
  isRead    Boolean              @default(false)
  readAt    DateTime?
  actionUrl String?
  priority  NotificationPriority @default(MEDIUM)
  expiresAt DateTime?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([isRead, createdAt])
  @@index([type, createdAt])
  @@map("notifications")
}

// ============================================================================
// AUDIT LOG SYSTEM
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  // Indexes
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([createdAt, action])
  @@map("audit_logs")
}

// ============================================================================
// SYNDICATE MANAGEMENT
// ============================================================================

model Syndicate {
  id                String          @id @default(cuid())
  name              String
  slug              String          @unique
  description       String?
  leadInvestorId    String
  targetAmount      Decimal         @db.Decimal(15, 2)
  minimumInvestment Decimal         @db.Decimal(15, 2)
  maxInvestors      Int?
  currentAmount     Decimal         @default(0) @db.Decimal(15, 2)
  investorCount     Int             @default(0)
  status            SyndicateStatus @default(FORMING)
  investmentTerms   Json?
  legalStructure    String?
  formationDate     DateTime?
  closingDate       DateTime?
  isActive          Boolean         @default(true)
  approvedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  leadInvestor User                  @relation("SyndicateLead", fields: [leadInvestorId], references: [id])
  investments  SyndicateInvestment[]
  spvs         Spv[]
  messages     SyndicateMessage[]
  documents    SyndicateDocument[]

  // Indexes
  @@index([leadInvestorId])
  @@index([status])
  @@index([isActive])
  @@index([createdAt])
  @@index([closingDate])
  @@index([status, isActive])
  @@map("syndicates")
}

model SyndicateInvestment {
  id             String                    @id @default(cuid())
  syndicateId    String
  investorId     String
  amount         Decimal                   @db.Decimal(15, 2)
  commitmentDate DateTime                  @default(now())
  status         SyndicateInvestmentStatus @default(COMMITTED)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  syndicate Syndicate @relation(fields: [syndicateId], references: [id], onDelete: Cascade)
  investor  User      @relation(fields: [investorId], references: [id])

  // Indexes
  @@index([syndicateId])
  @@index([investorId])
  @@index([status])
  @@index([commitmentDate])
  @@map("syndicate_investments")
}

// ============================================================================
// SPV MANAGEMENT
// ============================================================================

model Spv {
  id                 String    @id @default(cuid())
  name               String
  legalName          String
  syndicateId        String
  jurisdiction       String
  formationDate      DateTime?
  registrationNumber String?
  taxId              String?
  bankAccount        Json?
  status             SPVStatus @default(FORMING)
  totalCapital       Decimal   @default(0) @db.Decimal(15, 2)
  managementFee      Decimal?  @db.Decimal(5, 2)
  carriedInterest    Decimal?  @db.Decimal(5, 2)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  syndicate         Syndicate          @relation(fields: [syndicateId], references: [id], onDelete: Cascade)
  investments       SpvInvestment[]
  shareCertificates ShareCertificate[]

  // Indexes
  @@index([syndicateId])
  @@index([status])
  @@index([formationDate])
  @@index([registrationNumber])
  @@map("spvs")
}

model SpvInvestment {
  id                  String              @id @default(cuid())
  spvId               String
  investmentId        String              @unique
  ownershipPercentage Decimal             @db.Decimal(5, 2)
  capitalCommitment   Decimal             @db.Decimal(15, 2)
  status              SPVInvestmentStatus @default(ACTIVE)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  spv        Spv        @relation(fields: [spvId], references: [id], onDelete: Cascade)
  investment Investment @relation(fields: [investmentId], references: [id])

  // Indexes
  @@index([spvId])
  @@index([investmentId])
  @@index([status])
  @@map("spv_investments")
}

// ============================================================================
// SECONDARY MARKETPLACE
// ============================================================================

model Order {
  id                 String      @id @default(cuid())
  shareCertificateId String
  sellerId           String
  orderType          OrderType
  quantity           Int
  pricePerShare      Decimal     @db.Decimal(15, 2)
  totalAmount        Decimal     @db.Decimal(15, 2)
  status             OrderStatus @default(ACTIVE)
  expiresAt          DateTime?
  conditions         Json?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  shareCertificate ShareCertificate @relation(fields: [shareCertificateId], references: [id])
  seller           User             @relation(fields: [sellerId], references: [id])
  trades           Trade[]

  // Indexes
  @@index([shareCertificateId])
  @@index([sellerId])
  @@index([orderType])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([status, orderType])
  @@index([status, createdAt])
  @@map("orders")
}

model Trade {
  id                String      @id @default(cuid())
  orderId           String
  buyerId           String
  quantity          Int
  pricePerShare     Decimal     @db.Decimal(15, 2)
  totalAmount       Decimal     @db.Decimal(15, 2)
  fees              Decimal     @default(0) @db.Decimal(15, 2)
  status            TradeStatus @default(PENDING)
  executedAt        DateTime?
  settlementDate    DateTime?
  transferDocuments Json?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  order        Order         @relation(fields: [orderId], references: [id])
  buyer        User          @relation(fields: [buyerId], references: [id])
  transactions Transaction[]

  // Indexes
  @@index([orderId])
  @@index([buyerId])
  @@index([status])
  @@index([executedAt])
  @@index([settlementDate])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("trades")
}

model ShareCertificate {
  id                 String   @id @default(cuid())
  spvId              String
  originalInvestorId String
  currentOwnerId     String
  investmentId       String   @unique
  certificateNumber  String   @unique
  totalShares        Int
  sharePrice         Decimal  @db.Decimal(15, 2)
  totalValue         Decimal  @db.Decimal(15, 2)
  issuedDate         DateTime
  transferHistory    Json?
  isTransferable     Boolean  @default(true)
  restrictions       Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  spv              Spv        @relation(fields: [spvId], references: [id])
  originalInvestor User       @relation("OriginalShareholder", fields: [originalInvestorId], references: [id])
  currentOwner     User       @relation("CurrentShareholder", fields: [currentOwnerId], references: [id])
  investment       Investment @relation(fields: [investmentId], references: [id])
  orders           Order[]

  // Indexes
  @@index([spvId])
  @@index([originalInvestorId])
  @@index([currentOwnerId])
  @@index([investmentId])
  @@index([certificateNumber])
  @@index([isTransferable])
  @@index([issuedDate])
  @@map("share_certificates")
}

model SyndicateMessage {
  id          String               @id @default(cuid())
  syndicateId String
  senderId    String
  subject     String?
  content     String
  messageType SyndicateMessageType @default(GENERAL)
  isRead      Boolean              @default(false)
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  syndicate Syndicate @relation(fields: [syndicateId], references: [id], onDelete: Cascade)
  sender    User      @relation("SyndicateMessageSender", fields: [senderId], references: [id])

  // Indexes
  @@index([syndicateId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@index([syndicateId, createdAt])
  @@map("syndicate_messages")
}

model SyndicateDocument {
  id            String                @id @default(cuid())
  syndicateId   String
  name          String
  filePath      String
  fileUrl       String
  fileType      SyndicateDocumentType
  fileSize      Int
  mimeType      String?
  isPublic      Boolean               @default(false)
  downloadCount Int                   @default(0)
  uploadedBy    String
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  syndicate Syndicate @relation(fields: [syndicateId], references: [id], onDelete: Cascade)
  uploader  User      @relation("SyndicateDocumentUploader", fields: [uploadedBy], references: [id])

  // Indexes
  @@index([syndicateId])
  @@index([fileType])
  @@index([isPublic])
  @@index([uploadedBy])
  @@index([createdAt])
  @@map("syndicate_documents")
}

enum SyndicateMessageType {
  GENERAL
  INVESTMENT_UPDATE
  LEGAL_UPDATE
  DISTRIBUTION
  MEETING
}

enum SyndicateDocumentType {
  SYNDICATE_AGREEMENT
  INVESTMENT_MEMORANDUM
  LEGAL_DOCUMENT
  FINANCIAL_STATEMENT
  MEETING_MINUTES
  OTHER
}

// ============================================================================
// COMPLIANCE MANAGEMENT
// ============================================================================

model ComplianceProfile {
  id                           String               @id @default(cuid())
  userId                       String               @unique
  // SEC Regulation D Compliance
  accreditedInvestorStatus     AccreditationStatus  @default(PENDING)
  accreditedInvestorVerifiedAt DateTime?
  accreditationDocuments       Json?
  netWorth                     Decimal?             @db.Decimal(15, 2)
  annualIncome                 Decimal?             @db.Decimal(15, 2)
  accreditationMethod          AccreditationMethod?
  accreditationExpiry          DateTime?
  // Enhanced KYC/AML
  kycStatus                    KycStatus            @default(PENDING)
  kycVerifiedAt                DateTime?
  kycDocuments                 Json?
  taxId                        String?
  address                      Json?
  amlStatus                    AmlStatus            @default(PENDING)
  amlVerifiedAt                DateTime?
  riskScore                    Int                  @default(0)
  pepStatus                    PepStatus            @default(NOT_PEP)
  sanctionStatus               SanctionStatus       @default(CLEAR)
  // GDPR Compliance
  gdprConsent                  Boolean              @default(false)
  gdprConsentDate              DateTime?
  gdprConsentVersion           String?
  dataProcessingConsent        Boolean              @default(false)
  marketingConsent             Boolean              @default(false)
  dataRetentionExpiry          DateTime?
  // Additional Compliance
  complianceNotes              String?
  lastComplianceReview         DateTime?
  nextComplianceReview         DateTime?
  createdAt                    DateTime             @default(now())
  updatedAt                    DateTime             @updatedAt

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  complianceLogs      ComplianceLog[]
  complianceDocuments ComplianceDocument[]

  // Indexes
  @@index([accreditedInvestorStatus])
  @@index([kycStatus])
  @@index([amlStatus])
  @@index([pepStatus])
  @@index([sanctionStatus])
  @@index([accreditationExpiry])
  @@index([dataRetentionExpiry])
  @@map("compliance_profiles")
}

model ComplianceLog {
  id                  String              @id @default(cuid())
  complianceProfileId String
  action              String
  details             Json?
  status              ComplianceLogStatus @default(PENDING)
  performedBy         String?
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime            @default(now())

  complianceProfile ComplianceProfile @relation(fields: [complianceProfileId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([complianceProfileId])
  @@index([status])
  @@index([createdAt])
  @@index([action])
  @@map("compliance_logs")
}

model ComplianceDocument {
  id                  String                 @id @default(cuid())
  complianceProfileId String
  documentType        ComplianceDocumentType
  fileName            String
  filePath            String
  fileUrl             String
  fileSize            Int
  mimeType            String?
  documentStatus      DocumentStatus         @default(PENDING)
  verifiedAt          DateTime?
  verifiedBy          String?
  expiryDate          DateTime?
  notes               String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  complianceProfile ComplianceProfile @relation(fields: [complianceProfileId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([complianceProfileId])
  @@index([documentType])
  @@index([documentStatus])
  @@index([expiryDate])
  @@index([createdAt])
  @@map("compliance_documents")
}

model SECRegulationD {
  id                            String             @id @default(cuid())
  investmentId                  String             @unique
  // Regulation D Rule 506(c) requirements
  isAccreditedInvestor          Boolean
  verificationMethod            VerificationMethod
  issuerVerification            Boolean            @default(false)
  investorAttestation           Boolean            @default(false)
  // Investment limits and calculations
  investmentAmount              Decimal            @db.Decimal(15, 2)
  netWorth                      Decimal?           @db.Decimal(15, 2)
  annualIncome                  Decimal?           @db.Decimal(15, 2)
  investmentPercentage          Decimal?           @db.Decimal(5, 2)
  // Documentation and compliance
  disclosureDocument            String?
  subscriptionAgreement         String?
  accreditedInvestorCertificate String?
  complianceNotes               String?
  filedWithSEC                  Boolean            @default(false)
  filingDate                    DateTime?
  createdAt                     DateTime           @default(now())
  updatedAt                     DateTime           @updatedAt

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([isAccreditedInvestor])
  @@index([verificationMethod])
  @@index([filedWithSEC])
  @@index([filingDate])
  @@index([createdAt])
  @@map("sec_regulation_d")
}

// ============================================================================
// PERFORMANCE TRACKING AND ANALYTICS
// ============================================================================

model PerformanceMetric {
  id          String                @id @default(cuid())
  entityType  String // 'user', 'startup', 'investment', 'syndicate', 'spv'
  entityId    String
  metricType  PerformanceMetricType
  metricName  String
  metricValue Decimal               @db.Decimal(15, 2)
  metricUnit  String?
  period      String // 'daily', 'weekly', 'monthly', 'quarterly', 'yearly'
  periodStart DateTime
  periodEnd   DateTime
  metadata    Json?
  createdAt   DateTime              @default(now())

  // Indexes
  @@index([entityType])
  @@index([entityId])
  @@index([metricType])
  @@index([period])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([createdAt])
  @@index([entityType, entityId, metricType])
  @@index([period, periodStart])
  @@map("performance_metrics")
}

model AnalyticsSnapshot {
  id           String                @id @default(cuid())
  snapshotType AnalyticsSnapshotType
  entityType   String?
  entityId     String?
  data         Json
  snapshotDate DateTime
  createdAt    DateTime              @default(now())

  // Indexes
  @@index([snapshotType])
  @@index([entityType])
  @@index([entityId])
  @@index([snapshotDate])
  @@index([createdAt])
  @@index([snapshotType, snapshotDate])
  @@map("analytics_snapshots")
}

// ============================================================================
// SESSION MANAGEMENT (for authentication)
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([expires])
  @@index([sessionToken])
  @@map("sessions")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([token])
  @@index([expires])
  @@map("verifications")
}

// ============================================================================
// SUBSCRIPTION & PRICING MANAGEMENT
// ============================================================================

model SubscriptionPlan {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  tier              PlanTier
  price             Decimal            @db.Decimal(10, 2)
  billingInterval   BillingInterval
  features          Json // Feature flags and limits
  limits            Json // Usage limits (investments, documents, etc.)
  isActive          Boolean            @default(true)
  trialDays         Int                @default(14)
  stripePriceId     String?            @unique
  stripeProductId   String?            @unique
  displayOrder      Int                @default(0)
  description       String?            @db.Text
  highlightedText   String? // "Most Popular", "Best Value", etc.
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  subscriptions Subscription[]

  @@index([tier])
  @@index([isActive])
  @@index([billingInterval])
  @@map("subscription_plans")
}

model Subscription {
  id                    String              @id @default(cuid())
  userId                String
  planId                String
  status                SubscriptionStatus
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean             @default(false)
  canceledAt            DateTime?
  cancelReason          String?
  stripeSubscriptionId  String?             @unique
  stripeCustomerId      String?
  stripePaymentMethodId String?
  trialStart            DateTime?
  trialEnd              DateTime?
  metadata              Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan   @relation(fields: [planId], references: [id])
  invoices Invoice[]
  usage    SubscriptionUsage?

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Invoice {
  id                 String        @id @default(cuid())
  subscriptionId     String
  amount             Decimal       @db.Decimal(10, 2)
  tax                Decimal?      @db.Decimal(10, 2)
  total              Decimal       @db.Decimal(10, 2)
  currency           String        @default("USD")
  status             InvoiceStatus
  stripeInvoiceId    String?       @unique
  invoiceNumber      String?       @unique
  invoiceUrl         String?
  invoicePdf         String?
  periodStart        DateTime
  periodEnd          DateTime
  dueDate            DateTime?
  paidAt             DateTime?
  attemptCount       Int           @default(0)
  nextPaymentAttempt DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

model SubscriptionUsage {
  id                   String   @id @default(cuid())
  subscriptionId       String   @unique
  investmentsCreated   Int      @default(0)
  investmentsLimit     Int      @default(5)
  documentsUploaded    Int      @default(0)
  documentsLimit       Int      @default(100)
  storageUsedMB        Float    @default(0)
  storageLimitMB       Float    @default(100)
  apiCallsCount        Int      @default(0)
  apiCallsLimit        Int      @default(1000)
  resetDate            DateTime
  lastResetAt          DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([resetDate])
  @@map("subscription_usage")
}

model PaymentMethod {
  id                  String   @id @default(cuid())
  userId              String
  type                String // card, bank_account, etc.
  stripePaymentMethod String   @unique
  brand               String? // visa, mastercard, etc.
  last4               String?
  expiryMonth         Int?
  expiryYear          Int?
  isDefault           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentMethod])
  @@map("payment_methods")
}

// ============================================================================
// MONITORING AND ALERTING
// ============================================================================

model QueueMetrics {
  id                    String   @id @default(cuid())
  queueName             String
  waiting               Int
  active                Int
  completed             Int
  failed                Int
  delayed               Int
  paused                Int
  averageProcessingTime Float
  throughputPerSecond   Float
  errorRate             Float
  successRate           Float
  recordedAt            DateTime @default(now())
  createdAt             DateTime @default(now())

  // Indexes
  @@index([queueName])
  @@index([recordedAt])
  @@index([queueName, recordedAt])
  @@map("queue_metrics")
}

model SystemMetrics {
  id                 String   @id @default(cuid())
  timestamp          DateTime
  uptime             Float
  memoryUsed         Float
  memoryTotal        Float
  memoryPercentage   Float
  cpuUsage           Float
  activeQueues       Int
  totalQueues        Int
  activeWorkers      Int
  totalWorkers       Int
  dbConnections      Int
  dbQueriesPerSecond Float
  wsConnections      Int
  wsRooms            Int
  metadata           Json?
  createdAt          DateTime @default(now())

  // Indexes
  @@index([timestamp])
  @@index([createdAt])
  @@map("system_metrics")
}

model Alert {
  id          String    @id @default(cuid())
  type        String
  severity    String
  message     String
  details     Json?
  isResolved  Boolean   @default(false)
  resolvedAt  DateTime?
  triggeredAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Indexes
  @@index([type])
  @@index([severity])
  @@index([isResolved])
  @@index([triggeredAt])
  @@index([type, severity])
  @@index([isResolved, triggeredAt])
  @@map("alerts")
}

// ============================================================================
// ADMIN APPROVAL SYSTEM
// ============================================================================

model AdminApproval {
  id          String             @id @default(cuid())
  entityType  ApprovalEntityType
  entityId    String
  requestedBy String
  assignedTo  String?
  reviewedBy  String?
  status      ApprovalStatus     @default(PENDING)
  priority    ApprovalPriority   @default(MEDIUM)
  reason      String?            @db.Text
  reviewNotes String?            @db.Text
  tags        String[]           @default([])
  metadata    Json               @default("{}")
  slaDeadline DateTime
  reviewedAt  DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relations
  requester User               @relation("ApprovalRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
  assignee  User?              @relation("ApprovalAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  reviewer  User?              @relation("ApprovalReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  auditLogs ApprovalAuditLog[]

  // Indexes
  @@index([entityType])
  @@index([entityId])
  @@index([status])
  @@index([priority])
  @@index([requestedBy])
  @@index([assignedTo])
  @@index([reviewedBy])
  @@index([slaDeadline])
  @@index([createdAt])
  @@index([status, priority])
  @@index([entityType, status])
  @@index([assignedTo, status])
  @@map("admin_approvals")
}

model ApprovalAuditLog {
  id          String   @id @default(cuid())
  approvalId  String
  action      String
  performedBy String
  details     Json     @default("{}")
  createdAt   DateTime @default(now())

  // Relations
  approval AdminApproval @relation(fields: [approvalId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([approvalId])
  @@index([action])
  @@index([performedBy])
  @@index([createdAt])
  @@map("approval_audit_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  FOUNDER
  INVESTOR
  SYNDICATE_LEAD
  ADMIN
}

enum AccreditationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum StartupStage {
  IDEA
  PROTOTYPE
  MVP
  GROWTH
  SCALE
}

enum PitchStatus {
  DRAFT
  UNDER_REVIEW
  ACTIVE
  REJECTED
  FUNDED
  CLOSED
  WITHDRAWN
}

enum InvestmentStatus {
  PENDING
  APPROVED
  REJECTED
  ESCROW
  DUE_DILIGENCE
  LEGAL_REVIEW
  COMPLETED
  CANCELLED
}

enum InvestmentType {
  DIRECT
  SYNDICATE
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  FEE
  INVESTMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum MessageType {
  GENERAL
  PITCH_INQUIRY
  INVESTMENT_DISCUSSION
  SUPPORT
}

enum DocumentType {
  PITCH_DECK
  BUSINESS_PLAN
  FINANCIAL_STATEMENT
  LEGAL_DOCUMENT
  OTHER
}

enum NotificationType {
  INVESTMENT_UPDATE
  INVESTMENT
  MESSAGE
  PITCH_UPDATE
  PITCH
  SYNDICATE
  SYSTEM
  PAYMENT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

// ============================================================================
// COMPANY UPDATE ENUMS
// ============================================================================

enum UpdateType {
  MILESTONE
  FINANCIAL
  PRODUCT
  TEAM
  FUNDRAISING
  MARKET
  PARTNERSHIP
  MEDIA
  GENERAL
}

enum UpdateCategory {
  ACHIEVEMENT
  ANNOUNCEMENT
  PROGRESS_REPORT
  QUARTERLY_UPDATE
  INVESTOR_UPDATE
  PRESS_RELEASE
  EVENT
  BLOG_POST
}

enum UpdateStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
  DELETED
}

enum ReactionType {
  LIKE
  CELEBRATE
  SUPPORT
  INSIGHTFUL
  CURIOUS
}

// ============================================================================
// SYNDICATE ENUMS
// ============================================================================

enum SyndicateStatus {
  FORMING
  ACTIVE
  REJECTED
  FULLY_FUNDED
  CLOSING
  CLOSED
  CANCELLED
}

enum SyndicateInvestmentStatus {
  COMMITTED
  FUNDED
  DISTRIBUTED
  EXITED
  CANCELLED
}

enum SPVStatus {
  FORMING
  ACTIVE
  REJECTED
  DISSOLVING
  DISSOLVED
}

enum SPVInvestmentStatus {
  ACTIVE
  TRANSFERRED
  EXITED
  CANCELLED
}

// ============================================================================
// SECONDARY MARKETPLACE ENUMS
// ============================================================================

enum OrderType {
  BUY
  SELL
}

enum OrderStatus {
  ACTIVE
  PARTIALLY_FILLED
  FILLED
  CANCELLED
  EXPIRED
}

enum TradeStatus {
  PENDING
  EXECUTED
  SETTLED
  FAILED
  CANCELLED
}

// ============================================================================
// COMPLIANCE ENUMS
// ============================================================================

enum AccreditationMethod {
  NET_WORTH
  INCOME
  PROFESSIONAL
  EXISTING_RELATIONSHIP
  THIRD_PARTY_VERIFICATION
}

enum AmlStatus {
  PENDING
  PASSED
  FAILED
  REQUIRES_REVIEW
  EXEMPT
}

enum PepStatus {
  NOT_PEP
  PEP
  FAMILY_MEMBER
  CLOSE_ASSOCIATE
}

enum SanctionStatus {
  CLEAR
  PARTIAL_MATCH
  FULL_MATCH
  UNDER_REVIEW
}

enum ComplianceLogStatus {
  PENDING
  COMPLETED
  FAILED
  REQUIRES_REVIEW
}

enum ComplianceDocumentType {
  PASSPORT
  DRIVERS_LICENSE
  PROOF_OF_ADDRESS
  BANK_STATEMENT
  TAX_RETURN
  ACCREDITATION_CERTIFICATE
  SOURCE_OF_FUNDS
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum VerificationMethod {
  SELF_ATTESTATION
  THIRD_PARTY_VERIFICATION
  DOCUMENTARY_EVIDENCE
  EXISTING_RELATIONSHIP
}

// ============================================================================
// ADMIN APPROVAL ENUMS
// ============================================================================

enum ApprovalEntityType {
  INVESTMENT
  PITCH
  SYNDICATE
  USER
  KYC
  ACCREDITATION
  SPV
  DOCUMENT
}

enum ApprovalStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  REQUIRES_MORE_INFO
  ESCALATED
}

enum ApprovalPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================================
// PERFORMANCE AND ANALYTICS ENUMS
// ============================================================================

enum PerformanceMetricType {
  INVESTMENT_RETURN
  PORTFOLIO_VALUE
  USER_ACTIVITY
  PLATFORM_METRIC
  STARTUP_METRIC
  SYNDICATE_METRIC
  SPV_METRIC
  COMPLIANCE_METRIC
}

enum AnalyticsSnapshotType {
  DAILY_SUMMARY
  WEEKLY_SUMMARY
  MONTHLY_SUMMARY
  USER_ANALYTICS
  STARTUP_ANALYTICS
  INVESTMENT_ANALYTICS
  SYNDICATE_ANALYTICS
  SPV_ANALYTICS
  COMPLIANCE_ANALYTICS
  PLATFORM_OVERVIEW
}

// ============================================================================
// INVESTMENT INSTRUMENTS
// ============================================================================

// SAFE (Simple Agreement for Future Equity)
model SafeAgreement {
  id                 String     @id @default(cuid())
  investmentId       String     @unique
  type               SafeType
  investmentAmount   Decimal    @db.Decimal(15, 2)
  valuationCap       Decimal?   @db.Decimal(15, 2)
  discountRate       Decimal?   @db.Decimal(5, 2)
  proRataRight       Boolean    @default(false)
  mfnProvision       Boolean    @default(false) // Most Favored Nation
  conversionTriggers Json? // Equity financing, liquidity, dissolution
  conversionPrice    Decimal?   @db.Decimal(15, 2)
  conversionDate     DateTime?
  status             SafeStatus @default(ACTIVE)
  documentUrl        String?
  issueDate          DateTime   @default(now())
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([status])
  @@index([type])
  @@index([issueDate])
  @@map("safe_agreements")
}

// Convertible Note
model ConvertibleNote {
  id                          String          @id @default(cuid())
  investmentId                String          @unique
  principalAmount             Decimal         @db.Decimal(15, 2)
  interestRate                Decimal         @db.Decimal(5, 2) // Annual rate
  maturityDate                DateTime
  discountRate                Decimal?        @db.Decimal(5, 2)
  valuationCap                Decimal?        @db.Decimal(15, 2)
  conversionPrice             Decimal?        @db.Decimal(15, 2)
  autoConversion              Boolean         @default(true)
  qualifiedFinancingThreshold Decimal?        @db.Decimal(15, 2)
  securityType                String          @default("Preferred")
  compounding                 CompoundingType @default(SIMPLE)
  status                      NoteStatus      @default(ACTIVE)
  accrualSchedule             Json?
  accruedInterest             Decimal         @default(0) @db.Decimal(15, 2)
  lastAccrualDate             DateTime?
  documentUrl                 String?
  issueDate                   DateTime        @default(now())
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([status])
  @@index([maturityDate])
  @@index([issueDate])
  @@map("convertible_notes")
}

// Priced Equity Round
model EquityRound {
  id                    String            @id @default(cuid())
  startupId             String
  roundName             String
  roundType             RoundType
  pricePerShare         Decimal           @db.Decimal(15, 2)
  preMoneyValuation     Decimal           @db.Decimal(15, 2)
  postMoneyValuation    Decimal           @db.Decimal(15, 2)
  targetAmount          Decimal           @db.Decimal(15, 2)
  minimumRaise          Decimal?          @db.Decimal(15, 2)
  maximumRaise          Decimal?          @db.Decimal(15, 2)
  leadInvestorId        String?
  closingDate           DateTime?
  shareClass            String
  liquidationPreference Decimal           @default(1) @db.Decimal(5, 2)
  participationRight    Boolean           @default(false)
  dividendRate          Decimal?          @db.Decimal(5, 2)
  antiDilution          AntiDilutionType?
  votingRights          Json?
  boardSeats            Int?
  proRataRights         Boolean           @default(true)
  status                RoundStatus       @default(PLANNING)
  documentUrl           String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  startup      Startup     @relation(fields: [startupId], references: [id], onDelete: Cascade)
  leadInvestor User?       @relation(fields: [leadInvestorId], references: [id])
  termSheets   TermSheet[]

  @@index([startupId])
  @@index([leadInvestorId])
  @@index([status])
  @@index([roundType])
  @@index([closingDate])
  @@map("equity_rounds")
}

// ============================================================================
// CAP TABLE MANAGEMENT
// ============================================================================

model CapTable {
  id                 String   @id @default(cuid())
  startupId          String
  asOfDate           DateTime
  version            Int      @default(1)
  fullyDilutedShares Decimal  @db.Decimal(15, 2)
  totalCommon        Decimal  @db.Decimal(15, 2)
  totalPreferred     Decimal  @db.Decimal(15, 2)
  totalOptions       Decimal  @db.Decimal(15, 2)
  optionPool         Decimal  @db.Decimal(15, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  startup      Startup               @relation(fields: [startupId], references: [id], onDelete: Cascade)
  shareClasses ShareClass[]
  stakeholders CapTableStakeholder[]
  events       CapTableEvent[]

  @@index([startupId])
  @@index([asOfDate])
  @@index([version])
  @@map("cap_tables")
}

model ShareClass {
  id                    String            @id @default(cuid())
  capTableId            String
  name                  String
  type                  ShareClassType
  sharesAuthorized      Decimal           @db.Decimal(15, 2)
  sharesIssued          Decimal           @db.Decimal(15, 2)
  sharesOutstanding     Decimal           @db.Decimal(15, 2)
  pricePerShare         Decimal?          @db.Decimal(15, 2)
  liquidationPreference Decimal           @default(0) @db.Decimal(15, 2)
  liquidationMultiple   Decimal           @default(1) @db.Decimal(5, 2)
  participating         Boolean           @default(false)
  seniorityRank         Int
  conversionRatio       Decimal?          @db.Decimal(10, 4)
  antiDilution          AntiDilutionType?
  votesPerShare         Decimal           @default(1) @db.Decimal(10, 2)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  capTable CapTable @relation(fields: [capTableId], references: [id], onDelete: Cascade)

  @@index([capTableId])
  @@index([type])
  @@map("share_classes")
}

model CapTableStakeholder {
  id                    String          @id @default(cuid())
  capTableId            String
  stakeholderType       StakeholderType
  userId                String?
  entityName            String
  commonShares          Decimal         @default(0) @db.Decimal(15, 2)
  preferredShares       Json? // { "Series A": 1000, "Series B": 500 }
  options               Decimal         @default(0) @db.Decimal(15, 2)
  warrants              Decimal         @default(0) @db.Decimal(15, 2)
  fullyDilutedOwnership Decimal         @db.Decimal(5, 4)
  currentOwnership      Decimal         @db.Decimal(5, 4)
  vestingSchedule       Json?
  vestedShares          Decimal?        @db.Decimal(15, 2)
  unvestedShares        Decimal?        @db.Decimal(15, 2)
  boardSeat             Boolean         @default(false)
  observer              Boolean         @default(false)
  proRataRights         Boolean         @default(false)
  acquisitionDate       DateTime?
  acquisitionPrice      Decimal?        @db.Decimal(15, 2)
  acquisitionRoundId    String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  capTable CapTable @relation(fields: [capTableId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([capTableId])
  @@index([userId])
  @@index([stakeholderType])
  @@map("cap_table_stakeholders")
}

model CapTableEvent {
  id            String            @id @default(cuid())
  capTableId    String
  eventDate     DateTime
  eventType     CapTableEventType
  description   String
  sharesBefore  Json
  sharesAfter   Json
  roundId       String?
  transactionId String?
  createdAt     DateTime          @default(now())

  capTable CapTable @relation(fields: [capTableId], references: [id], onDelete: Cascade)

  @@index([capTableId])
  @@index([eventDate])
  @@index([eventType])
  @@map("cap_table_events")
}

// ============================================================================
// TERM SHEET MANAGEMENT
// ============================================================================

model TermSheet {
  id                   String            @id @default(cuid())
  roundId              String
  version              Int               @default(1)
  status               TermSheetStatus   @default(DRAFT)
  expirationDate       DateTime?
  investmentAmount     Decimal           @db.Decimal(15, 2)
  valuation            Decimal           @db.Decimal(15, 2)
  securityType         String
  liquidationPref      Decimal           @db.Decimal(5, 2)
  participationRight   Boolean
  dividendRate         Decimal?          @db.Decimal(5, 2)
  antiDilution         AntiDilutionType?
  boardSeats           Int?
  boardObservers       Int?
  protectiveProvisions Json?
  votingRights         Json?
  informationRights    Json?
  proRataRights        Boolean           @default(true)
  redemptionRights     Boolean           @default(false)
  dragAlongRights      Boolean           @default(true)
  tagAlongRights       Boolean           @default(true)
  rightOfFirstRefusal  Boolean           @default(true)
  coSaleRights         Boolean           @default(true)
  redemptionPrice      Decimal?          @db.Decimal(15, 2)
  redemptionPeriod     String?
  noShopPeriod         Int? // Days
  exclusivity          Boolean           @default(false)
  breakupFee           Decimal?          @db.Decimal(15, 2)
  documentUrl          String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  round        EquityRound            @relation(fields: [roundId], references: [id], onDelete: Cascade)
  negotiations TermSheetNegotiation[]
  signatures   TermSheetSignature[]
  comments     TermSheetComment[]

  @@index([roundId])
  @@index([status])
  @@index([version])
  @@index([expirationDate])
  @@map("term_sheets")
}

model TermSheetNegotiation {
  id          String   @id @default(cuid())
  termSheetId String
  userId      String
  changeType  String
  fieldName   String
  oldValue    Json?
  newValue    Json?
  reason      String?
  status      String   @default("PROPOSED")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  termSheet TermSheet @relation(fields: [termSheetId], references: [id], onDelete: Cascade)

  @@index([termSheetId])
  @@index([userId])
  @@index([status])
  @@map("term_sheet_negotiations")
}

model TermSheetSignature {
  id              String          @id @default(cuid())
  termSheetId     String
  signerId        String
  signerRole      String
  sentAt          DateTime?
  signedAt        DateTime?
  ipAddress       String?
  signatureMethod String?
  signatureData   String?
  status          SignatureStatus @default(PENDING)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  termSheet TermSheet @relation(fields: [termSheetId], references: [id], onDelete: Cascade)

  @@index([termSheetId])
  @@index([signerId])
  @@index([status])
  @@map("term_sheet_signatures")
}

model TermSheetComment {
  id          String   @id @default(cuid())
  termSheetId String
  userId      String
  content     String   @db.Text
  section     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  termSheet TermSheet @relation(fields: [termSheetId], references: [id], onDelete: Cascade)

  @@index([termSheetId])
  @@index([userId])
  @@map("term_sheet_comments")
}

// ============================================================================
// DOCUMENT AUTOMATION
// ============================================================================

model DocumentTemplate {
  id             String                   @id @default(cuid())
  name           String
  category       DocumentTemplateCategory
  jurisdictions  String[]
  version        String
  templateUrl    String
  variableFields Json
  lawyerReviewed Boolean                  @default(false)
  reviewDate     DateTime?
  isActive       Boolean                  @default(true)
  useCount       Int                      @default(0)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  generations DocumentGeneration[]

  @@index([category])
  @@index([isActive])
  @@map("document_templates")
}

model DocumentGeneration {
  id           String                   @id @default(cuid())
  templateId   String
  investmentId String?
  roundId      String?
  mergeData    Json
  documentUrl  String
  generatedAt  DateTime                 @default(now())
  status       DocumentGenerationStatus @default(DRAFT)
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  template   DocumentTemplate    @relation(fields: [templateId], references: [id])
  signatures DocumentSignature[]

  @@index([templateId])
  @@index([investmentId])
  @@index([roundId])
  @@index([status])
  @@map("document_generations")
}

model DocumentSignature {
  id              String          @id @default(cuid())
  documentId      String
  signerId        String
  signerRole      String
  sentAt          DateTime?
  signedAt        DateTime?
  ipAddress       String?
  signatureMethod String?
  signatureData   String?
  status          SignatureStatus @default(PENDING)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  document DocumentGeneration @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([signerId])
  @@index([status])
  @@map("document_signatures")
}

// ============================================================================
// INVESTOR RIGHTS & GOVERNANCE
// ============================================================================

model InvestorRights {
  id                     String            @id @default(cuid())
  investmentId           String            @unique
  userId                 String
  boardSeat              Boolean           @default(false)
  boardObserver          Boolean           @default(false)
  monthlyFinancials      Boolean           @default(false)
  quarterlyFinancials    Boolean           @default(true)
  annualFinancials       Boolean           @default(true)
  annualBudget           Boolean           @default(false)
  investorUpdates        Boolean           @default(true)
  protectiveProvisions   Json?
  proRataRight           Boolean           @default(false)
  majorInvestorRight     Boolean           @default(false)
  superProRata           Decimal?          @db.Decimal(5, 2)
  rightOfFirstRefusal    Boolean           @default(false)
  coSaleRight            Boolean           @default(false)
  dragAlongRight         Boolean           @default(false)
  redemptionRight        Boolean           @default(false)
  redemptionDate         DateTime?
  antiDilutionProtection AntiDilutionType?
  demandRights           Int?
  piggybackRights        Boolean           @default(false)
  s3Rights               Boolean           @default(false)
  mostFavoredNation      Boolean           @default(false)
  noShopWaiver           Boolean           @default(false)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([userId])
  @@index([boardSeat])
  @@index([proRataRight])
  @@map("investor_rights")
}

model BoardMeeting {
  id           String           @id @default(cuid())
  startupId    String
  meetingDate  DateTime
  meetingType  BoardMeetingType
  location     String?
  directors    Json
  observers    Json
  management   Json
  agenda       String?
  materials    String[]
  minutesUrl   String?
  recordingUrl String?
  status       MeetingStatus    @default(SCHEDULED)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  startup     Startup           @relation(fields: [startupId], references: [id], onDelete: Cascade)
  resolutions BoardResolution[]

  @@index([startupId])
  @@index([meetingDate])
  @@index([status])
  @@map("board_meetings")
}

model BoardResolution {
  id                    String            @id @default(cuid())
  meetingId             String
  resolutionNumber      String
  title                 String
  description           String            @db.Text
  proposedBy            String
  requiresMajority      Boolean           @default(true)
  requiresSupermajority Boolean           @default(false)
  requiredVotes         Int?
  result                ResolutionResult?
  passedDate            DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  meeting BoardMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  votes   BoardVote[]

  @@index([meetingId])
  @@index([result])
  @@map("board_resolutions")
}

model BoardVote {
  id           String   @id @default(cuid())
  resolutionId String
  voterId      String
  vote         VoteType
  votedAt      DateTime @default(now())
  comments     String?

  resolution BoardResolution @relation(fields: [resolutionId], references: [id], onDelete: Cascade)

  @@index([resolutionId])
  @@index([voterId])
  @@map("board_votes")
}

// ============================================================================
// FOLLOW-ON INVESTMENT & EXIT MANAGEMENT
// ============================================================================

model FollowOnInvestment {
  id                   String         @id @default(cuid())
  originalInvestmentId String
  investorId           String
  startupId            String
  roundId              String?
  proRataRight         Boolean
  entitlement          Decimal        @db.Decimal(15, 2)
  allocationUsed       Decimal        @default(0) @db.Decimal(15, 2)
  allocationRemaining  Decimal        @db.Decimal(15, 2)
  notificationDate     DateTime
  deadlineDate         DateTime
  exercisedDate        DateTime?
  exercised            Boolean        @default(false)
  declined             Boolean        @default(false)
  status               FollowOnStatus @default(OFFERED)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@index([originalInvestmentId])
  @@index([investorId])
  @@index([startupId])
  @@index([roundId])
  @@index([status])
  @@index([deadlineDate])
  @@map("follow_on_investments")
}

model ExitEvent {
  id               String     @id @default(cuid())
  startupId        String
  exitType         ExitType
  announcementDate DateTime
  closingDate      DateTime?
  totalProceeds    Decimal    @db.Decimal(15, 2)
  cashPortion      Decimal    @db.Decimal(15, 2)
  stockPortion     Decimal    @default(0) @db.Decimal(15, 2)
  earnoutPortion   Decimal?   @db.Decimal(15, 2)
  acquirerName     String?
  acquirerTicker   String?
  status           ExitStatus @default(ANNOUNCED)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  startup       Startup            @relation(fields: [startupId], references: [id], onDelete: Cascade)
  waterfall     ExitWaterfall?
  distributions ExitDistribution[]

  @@index([startupId])
  @@index([exitType])
  @@index([status])
  @@index([announcementDate])
  @@index([closingDate])
  @@map("exit_events")
}

model ExitWaterfall {
  id            String   @id @default(cuid())
  exitEventId   String   @unique
  totalProceeds Decimal  @db.Decimal(15, 2)
  layers        Json
  distributions Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  exitEvent ExitEvent @relation(fields: [exitEventId], references: [id], onDelete: Cascade)

  @@index([exitEventId])
  @@map("exit_waterfalls")
}

model ExitDistribution {
  id              String        @id @default(cuid())
  exitEventId     String
  stakeholderId   String
  cashAmount      Decimal       @db.Decimal(15, 2)
  stockAmount     Decimal?      @db.Decimal(15, 2)
  earnoutAmount   Decimal?      @db.Decimal(15, 2)
  liquidationPref Decimal       @db.Decimal(15, 2)
  proRataShare    Decimal       @db.Decimal(5, 4)
  totalReturn     Decimal       @db.Decimal(15, 2)
  returnMultiple  Decimal       @db.Decimal(5, 2)
  paymentDate     DateTime?
  paymentStatus   PaymentStatus @default(PENDING)
  taxWithholding  Decimal?      @db.Decimal(15, 2)
  taxForms        String[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  exitEvent ExitEvent @relation(fields: [exitEventId], references: [id], onDelete: Cascade)

  @@index([exitEventId])
  @@index([stakeholderId])
  @@index([paymentStatus])
  @@map("exit_distributions")
}

// ============================================================================
// NEW ENUMS
// ============================================================================

enum SafeType {
  POST_MONEY
  PRE_MONEY
}

enum SafeStatus {
  ACTIVE
  CONVERTED
  DISSOLVED
  CANCELLED
}

enum CompoundingType {
  SIMPLE
  COMPOUND
}

enum NoteStatus {
  ACTIVE
  CONVERTED
  MATURED
  REPAID
  DEFAULTED
  CANCELLED
}

enum RoundType {
  SEED
  SERIES_A
  SERIES_B
  SERIES_C
  SERIES_D
  SERIES_E
  BRIDGE
  EXTENSION
}

enum RoundStatus {
  PLANNING
  OPEN
  CLOSING
  CLOSED
  CANCELLED
}

enum AntiDilutionType {
  WEIGHTED_AVERAGE
  FULL_RATCHET
  NONE
}

enum ShareClassType {
  COMMON
  PREFERRED
  OPTION
  WARRANT
}

enum StakeholderType {
  FOUNDER
  EMPLOYEE
  INVESTOR
  ADVISOR
  CONSULTANT
}

enum CapTableEventType {
  FUNDING
  CONVERSION
  OPTION_GRANT
  OPTION_EXERCISE
  TRANSFER
  REPURCHASE
  CANCELLATION
}

enum TermSheetStatus {
  DRAFT
  SENT
  NEGOTIATING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum SignatureStatus {
  PENDING
  SIGNED
  DECLINED
  EXPIRED
}

enum DocumentTemplateCategory {
  SAFE
  CONVERTIBLE_NOTE
  TERM_SHEET
  STOCK_PURCHASE_AGREEMENT
  SUBSCRIPTION_AGREEMENT
  SHAREHOLDERS_AGREEMENT
  VOTING_AGREEMENT
  RIGHT_OF_FIRST_REFUSAL
  CO_SALE_AGREEMENT
  INVESTOR_RIGHTS_AGREEMENT
  NDA
  OTHER
}

enum DocumentGenerationStatus {
  DRAFT
  SENT_FOR_SIGNATURE
  PARTIALLY_SIGNED
  FULLY_EXECUTED
  CANCELLED
}

enum BoardMeetingType {
  REGULAR
  SPECIAL
  ANNUAL
  EMERGENCY
}

enum MeetingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ResolutionResult {
  PASSED
  FAILED
  ABSTAINED
  TABLED
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN
}

enum FollowOnStatus {
  OFFERED
  ACCEPTED
  DECLINED
  EXPIRED
  EXERCISED
}

enum ExitType {
  ACQUISITION
  IPO
  MERGER
  LIQUIDATION
  SECONDARY_SALE
}

enum ExitStatus {
  ANNOUNCED
  PENDING
  CLOSED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SENT
  RECEIVED
  FAILED
}

// ============================================================================
// SUBSCRIPTION & PRICING ENUMS
// ============================================================================

enum PlanTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum BillingInterval {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// ============================================================================
// INDEXES AND PERFORMANCE OPTIMIZATIONS
// ============================================================================

// ============================================================================
// INDEXES AND PERFORMANCE OPTIMIZATIONS
// ============================================================================

// Note: Indexes are defined within each model above for better organization
// and to ensure they reference the correct fields within their respective models
